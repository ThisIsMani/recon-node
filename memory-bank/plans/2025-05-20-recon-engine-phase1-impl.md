# Plan: Recon Engine Implementation - Phase 1 (Component)

**Date:** 2025-05-20
**Objective:** Implement the core Recon Engine component (`engine.js`) as per the refined Phase 1 requirements. This component will take a `StagingEntry` and `merchantId`, apply `ReconRule`s, and generate data for "actual" and "expected" entries.

## Steps

| Done | # | Action                                                                 | Detail                                                                                                                                                                                             |
|------|---|------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [ ]  | 1 | Create `src/server/core/recon-engine/engine.js`                        | Initialize the file with Prisma client, enum imports, `NoReconRuleFoundError` custom error class, and the `generateTransactionEntriesFromStaging` function signature.                               |
| [ ]  | 2 | Implement `generateTransactionEntriesFromStaging` function             | Add logic to extract `order_id`, prepare "actual" entry data (`POSTED`), find `ReconRule` (throw `NoReconRuleFoundError` if not found), generate "expected" entry data (`EXPECTED`), and return both. |
| [ ]  | 3 | Create `memory-bank/entities/recon-engine.md`                          | Add a new Memory Bank entity document describing the Recon Engine component, its purpose, and key functions.                                                                                       |
| [ ]  | 4 | Update `memory-bank/index.md`                                          | Add a link to the new `recon-engine.md` entity document in the main Memory Bank index.                                                                                                             |
| [ ]  | 5 | Update `memory-bank/entities/entries.md`                               | Document the usage of `order_id` in `Entry.metadata` and the `EXPECTED` status for entries generated by the Recon Engine.                                                                          |
| [ ]  | 6 | Update `memory-bank/systemPatterns.md`                                 | Describe the new Recon Engine component and its role within the system architecture.                                                                                                               |
| [ ]  | 7 | Update `memory-bank/activeContext.md`                                  | Summarize the implementation of the Recon Engine Phase 1, key decisions, and current project focus.                                                                                                |
| [ ]  | 8 | Update `memory-bank/progress.md`                                       | Log the completion of Recon Engine Phase 1 implementation.                                                                                                                                         |

<!--
{
  "planVersion": "1.0",
  "planName": "Recon Engine Implementation - Phase 1 (Component)",
  "lastUpdated": "2025-05-20T17:12:00Z",
  "plan": [
    {
      "id": 1,
      "action": "Create `src/server/core/recon-engine/engine.js`",
      "tool": "write_to_file",
      "args": {
        "path": "src/server/core/recon-engine/engine.js",
        "content": "// src/server/core/recon-engine/engine.js\nconst prisma = require('../../../services/prisma');\nconst { EntryStatus, EntryType } = require('@prisma/client');\n\n/**\n * Custom error for when no reconciliation rule is found.\n */\nclass NoReconRuleFoundError extends Error {\n  constructor(message) {\n    super(message);\n    this.name = 'NoReconRuleFoundError';\n  }\n}\n\n/**\n * Generates actual and expected entry data from a staging entry based on recon rules.\n * @param {object} stagingEntry - The staging entry object.\n * @param {string} merchantId - The ID of the merchant.\n * @returns {Promise<Array<object>>} A promise that resolves to an array containing two objects: [actualEntryData, expectedEntryData].\n * @throws {NoReconRuleFoundError} If no matching ReconRule is found.\n */\nasync function generateTransactionEntriesFromStaging(stagingEntry, merchantId) {\n  // Implementation to be added in step 2\n  throw new Error('Not yet implemented');\n}\n\nmodule.exports = {\n  generateTransactionEntriesFromStaging,\n  NoReconRuleFoundError,\n};\n"
      },
      "success": "File `src/server/core/recon-engine/engine.js` created with initial structure, NoReconRuleFoundError class, and function signature.",
      "status": "pending"
    },
    {
      "id": 2,
      "action": "Implement `generateTransactionEntriesFromStaging` function",
      "tool": "replace_in_file",
      "args": {
        "path": "src/server/core/recon-engine/engine.js",
        "diff": "<<<<<<< SEARCH\n  // Implementation to be added in step 2\n  throw new Error('Not yet implemented');\n=======\n  const order_id = stagingEntry.metadata?.order_id;\n\n  const actualEntryData = {\n    account_id: stagingEntry.account_id,\n    entry_type: stagingEntry.entry_type,\n    amount: stagingEntry.amount,\n    currency: stagingEntry.currency,\n    status: EntryStatus.POSTED,\n    effective_date: stagingEntry.effective_date,\n    metadata: {\n      ...(stagingEntry.metadata || {}),\n      order_id: order_id,\n      source_staging_entry_id: stagingEntry.staging_entry_id,\n    },\n  };\n\n  const reconRule = await prisma.reconRule.findFirst({\n    where: {\n      merchant_id: merchantId,\n      OR: [\n        { account_one_id: stagingEntry.account_id },\n        { account_two_id: stagingEntry.account_id },\n      ],\n    },\n  });\n\n  if (!reconRule) {\n    throw new NoReconRuleFoundError(\n      `No reconciliation rule found for merchant ${merchantId} and account ${stagingEntry.account_id}`\n    );\n  }\n\n  let contra_account_id;\n  if (reconRule.account_one_id === stagingEntry.account_id) {\n    contra_account_id = reconRule.account_two_id;\n  } else {\n    contra_account_id = reconRule.account_one_id;\n  }\n\n  const expectedEntryType = stagingEntry.entry_type === EntryType.DEBIT ? EntryType.CREDIT : EntryType.DEBIT;\n\n  const expectedEntryData = {\n    account_id: contra_account_id,\n    entry_type: expectedEntryType,\n    amount: stagingEntry.amount,\n    currency: stagingEntry.currency,\n    status: EntryStatus.EXPECTED,\n    effective_date: stagingEntry.effective_date,\n    metadata: {\n      order_id: order_id,\n      source_staging_entry_id: stagingEntry.staging_entry_id,\n      recon_rule_id: reconRule.id,\n    },\n  };\n\n  return [actualEntryData, expectedEntryData];\n>>>>>>> REPLACE"
      },
      "success": "Function `generateTransactionEntriesFromStaging` implemented correctly.",
      "status": "pending"
    },
    {
      "id": 3,
      "action": "Create `memory-bank/entities/recon-engine.md`",
      "tool": "write_to_file",
      "args": {
        "path": "memory-bank/entities/recon-engine.md",
        "content": "# Entity: Recon Engine\n\n**Purpose:** The Recon Engine is a core component responsible for applying reconciliation rules (`ReconRule`) to incoming financial data (typically `StagingEntry` objects) to generate data for both an \"actual\" ledger entry and an \"expected\" contra-entry.\n\n**Key Functions/Modules:**\n- `src/server/core/recon-engine/engine.js`:\n  - `async function generateTransactionEntriesFromStaging(stagingEntry, merchantId)`: Takes a staging entry and merchant ID, looks up the relevant `ReconRule`, and produces data for two `Entry` objects (one actual, one expected).\n    - Throws `NoReconRuleFoundError` if a rule cannot be found.\n\n**Data Flow:**\n1. Receives a `StagingEntry` and `merchantId`.\n2. Extracts key information like `order_id` from `stagingEntry.metadata`.\n3. Prepares data for the \"actual\" entry (status: `POSTED`).\n4. Looks up a `ReconRule` based on `stagingEntry.account_id` and `merchantId`.\n5. If no rule is found, it throws `NoReconRuleFoundError`.\n6. If a rule is found, it determines the contra-account, the opposite entry type, and prepares data for the \"expected\" entry (status: `EXPECTED`).\n7. Returns an array containing the data for the actual entry and the expected entry.\n\nThis component is crucial for automating the creation of double-entry bookkeeping records based on defined business logic."
      },
      "success": "`memory-bank/entities/recon-engine.md` created with component description.",
      "status": "pending"
    },
    {
      "id": 4,
      "action": "Update `memory-bank/index.md`",
      "tool": "replace_in_file",
      "args": {
        "path": "memory-bank/index.md",
        "diff": "<<<<<<< SEARCH\n- **[Process Tracker (`entities/process-tracker.md`)](./entities/process-tracker.md):** Information related to the task management system for the Recon Engine.\n- *(Future entities will be added here as they are developed.)*\n=======\n- **[Process Tracker (`entities/process-tracker.md`)](./entities/process-tracker.md):** Information related to the task management system for the Recon Engine.\n- **[Recon Engine (`entities/recon-engine.md`)](./entities/recon-engine.md):** Information related to the core reconciliation engine component.\n- *(Future entities will be added here as they are developed.)*\n>>>>>>> REPLACE"
      },
      "success": "`memory-bank/index.md` updated with link to `recon-engine.md`.",
      "status": "pending"
    },
    {
      "id": 5,
      "action": "Update `memory-bank/entities/entries.md`",
      "tool": "replace_in_file",
      "args": {
        "path": "memory-bank/entities/entries.md",
        "diff": "<<<<<<< SEARCH\n### Metadata (`metadata` - JSON, Optional)\n- A flexible JSONB field to store any additional, non-standardized information related to the entry.\n- Example: `{\"payment_processor_id\": \"proc_123\", \"original_charge_id\": \"ch_abc\"}`\n=======\n### Metadata (`metadata` - JSON, Optional)\n- A flexible JSONB field to store any additional, non-standardized information related to the entry.\n- Example: `{\"payment_processor_id\": \"proc_123\", \"original_charge_id\": \"ch_abc\"}`\n- For entries generated from `StagingEntry` objects via the Recon Engine, this may include:\n  - `order_id`: Propagated from `StagingEntry.metadata`.\n  - `source_staging_entry_id`: The ID of the `StagingEntry` that originated this entry.\n  - `recon_rule_id`: (For 'expected' entries) The ID of the `ReconRule` used to generate this entry.\n\n### Status (`status` - Enum: `EXPECTED`, `POSTED`, `ARCHIVED`)\n- `EXPECTED`: Indicates an entry that is anticipated based on a rule or prior event but has not yet been confirmed by an actual corresponding event. The Recon Engine generates 'expected' entries.\n- `POSTED`: A confirmed, actual ledger entry.\n- `ARCHIVED`: An entry that is no longer active or has been superseded (e.g., a corrected entry replaces an archived one).\n>>>>>>> REPLACE"
      },
      "success": "`memory-bank/entities/entries.md` updated regarding metadata and EXPECTED status.",
      "status": "pending"
    },
    {
      "id": 6,
      "action": "Update `memory-bank/systemPatterns.md`",
      "tool": "replace_in_file",
      "args": {
        "path": "memory-bank/systemPatterns.md",
        "diff": "<<<<<<< SEARCH\n    - This pattern decouples the initial data ingestion (e.g., API creating `StagingEntry`) from more complex, potentially long-running processing, improving API responsiveness and system resilience.\n=======\n    - This pattern decouples the initial data ingestion (e.g., API creating `StagingEntry`) from more complex, potentially long-running processing, improving API responsiveness and system resilience.\n\n- **Recon Engine Component (`src/server/core/recon-engine/engine.js`):**\n    - This standalone component is responsible for applying business logic (`ReconRule`s) to input data (`StagingEntry`) to generate data for \"actual\" and \"expected\" ledger entries.\n    - It encapsulates the core reconciliation logic, making it reusable and testable in isolation.\n    - It is designed to be called by other parts of the system, such as the Recon Engine Consumer, to transform staging data into structured entry data suitable for creating transactions.\n>>>>>>> REPLACE"
      },
      "success": "`memory-bank/systemPatterns.md` updated with Recon Engine component description.",
      "status": "pending"
    },
    {
      "id": 7,
      "action": "Update `memory-bank/activeContext.md`",
      "tool": "replace_in_file",
      "args": {
        "path": "memory-bank/activeContext.md",
        "diff": "<<<<<<< SEARCH\n**Current Focus:**\n- Fixing test failures and improving code coverage across the application.\n=======\n**Current Focus:**\n- Implementing Phase 1 of the Recon Engine: The core `generateTransactionEntriesFromStaging` component.\n\n**Key Decisions & Changes (Recon Engine Phase 1):**\n- Created `src/server/core/recon-engine/engine.js`.\n- Implemented `generateTransactionEntriesFromStaging(stagingEntry, merchantId)` function:\n  - Extracts `order_id` from `stagingEntry.metadata`.\n  - Prepares \"actual\" entry data with status `POSTED`.\n  - Finds `ReconRule` using `stagingEntry.account_id` and `merchantId`.\n  - Throws `NoReconRuleFoundError` if no rule is found.\n  - Generates \"expected\" entry data with status `EXPECTED`, contra-account from rule, and mirrored financial details.\n  - Returns `[actualEntryData, expectedEntryData]`.\n- Defined `NoReconRuleFoundError` custom error.\n- Updated Memory Bank: `recon-engine.md` (new), `index.md`, `entries.md`, `systemPatterns.md`.\n\n**Next Steps (Immediate for this task):**\n- (This section will be updated upon completion of the current plan)\n>>>>>>> REPLACE"
      },
      "success": "`memory-bank/activeContext.md` updated to reflect Recon Engine Phase 1 progress.",
      "status": "pending"
    },
    {
      "id": 8,
      "action": "Update `memory-bank/progress.md`",
      "tool": "replace_in_file",
      "args": {
        "path": "memory-bank/progress.md",
        "diff": "<<<<<<< SEARCH\n# Progress Log: Smart Ledger Backend (Node.js)\n=======\n# Progress Log: Smart Ledger Backend (Node.js)\n\n---\n**Date:** 2025-05-20\n**Task:** Recon Engine - Phase 1: Implement Core Component (`engine.js`)\n**Status:** Completed\n**Summary:**\n- Created `src/server/core/recon-engine/engine.js`.\n- Implemented `async function generateTransactionEntriesFromStaging(stagingEntry, merchantId)`:\n  - Extracts `order_id` from `stagingEntry.metadata`.\n  - Prepares \"actual\" entry data (status `POSTED`).\n  - Finds `ReconRule` using `stagingEntry.account_id` and `merchantId`.\n  - Throws `NoReconRuleFoundError` if no rule is found.\n  - Generates \"expected\" entry data (status `EXPECTED`, contra-account from rule, mirrored financials).\n  - Returns `[actualEntryData, expectedEntryData]`.\n- Defined `NoReconRuleFoundError` custom error.\n- Updated Memory Bank: `recon-engine.md` (new), `index.md`, `entries.md`, `systemPatterns.md`, `activeContext.md`.\n**Issues/Notes:** None.\n>>>>>>> REPLACE"
      },
      "success": "`memory-bank/progress.md` updated with log entry for Recon Engine Phase 1.",
      "status": "pending"
    }
  ]
}
-->
