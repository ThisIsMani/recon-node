# Entity: Entries

**Overview:**
Entries represent final, posted financial movements within the Smart Ledger system. They are the core records that affect account balances and reflect confirmed transactions. Unlike Staging Entries, Entries are not typically created directly via an API but are the result of processing other data (e.g., Staging Entries, system-generated events).

**Prisma Schema Definition (`Entry` model from `prisma/schema.prisma`):**
```prisma
enum EntryStatus {
  EXPECTED  // Anticipated movement, possibly generated by a rule or system logic.
  POSTED    // Confirmed, final entry impacting the ledger's posted_balance.
  ARCHIVED  // Superseded, corrected, or otherwise no longer active; discarded_at should be set.
}

model Entry {
  entry_id         String      @id @default(cuid())
  account_id       String
  transaction_id   String      // Foreign Key to Transaction model (Mandatory)
  entry_type       EntryType   // Reuses existing DEBIT/CREDIT enum
  amount           Decimal
  currency         String
  status           EntryStatus
  effective_date   DateTime
  metadata         Json?       @db.JsonB
  discarded_at     DateTime?   // Set when status is ARCHIVED
  created_at       DateTime    @default(now())
  updated_at       DateTime    @updatedAt

  account          Account     @relation(fields: [account_id], references: [account_id])
  transaction      Transaction @relation(fields: [transaction_id], references: [transaction_id]) // Link to Transaction model (Mandatory)
}
```

**Metadata Details (`metadata` - JSON, Optional):**
- A flexible JSONB field to store any additional, non-standardized information related to the entry.
- Example: `{"payment_processor_id": "proc_123", "original_charge_id": "ch_abc"}`
- For entries generated from `StagingEntry` objects via the Recon Engine, this may include:
  - `order_id`: Propagated from `StagingEntry.metadata`.
  - `source_staging_entry_id`: The ID of the `StagingEntry` that originated this entry.
  - `recon_rule_id`: (For 'expected' entries) The ID of the `ReconRule` used to generate this entry.

**API Endpoints:**
- `GET /api/accounts/:account_id/entries`: List entries for the specified account. Supports filtering by `status` (e.g., `EXPECTED`, `POSTED`, `ARCHIVED`) via query parameters.
  - **Note:** There is no `POST` endpoint for creating entries directly via the API. Entries are created through internal system processes, and now *must* be associated with a transaction.

**Core Logic (`src/server/core/entry/index.js`):**
- `listEntries(account_id, queryParams)`: Retrieves entries for a given account, allowing filtering by status. Includes related account details.
- `createEntryInternal(entryData, tx?)`: (Internal function) Creates a single entry. Accepts an optional Prisma transaction client (`tx`) to participate in an ongoing database transaction.

**Lifecycle & Purpose:**
- `EXPECTED`: Indicates an entry that is anticipated based on a rule or prior event but has not yet been confirmed by an actual corresponding event. The Recon Engine generates 'expected' entries.
- `POSTED`: A confirmed financial movement that has impacted an account's balance. This is the primary active state for ledger entries.
- `ARCHIVED`: An entry that is no longer active, typically because it has been corrected, superseded, or is part of a voided transaction. The `discarded_at` field should be populated for these entries.

**Future Considerations:**
- The `Transaction` model groups related entries. An `Entry` must always belong to a `Transaction`.
- Logic for calculating account balances will primarily use `POSTED` entries.
- Internal processes are responsible for creating `Entry` records, ensuring they are linked to a `Transaction`. This typically happens when a `Transaction` is created (e.g., via `createTransactionInternal`) or when `StagingEntry` records are processed by the Recon Engine.
