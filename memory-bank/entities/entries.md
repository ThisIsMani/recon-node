# Entity: Entries

**Overview:**
Entries represent final, posted financial movements within the Smart Ledger system. They are the core records that affect account balances and reflect confirmed transactions. Entries are typically created as part of a `Transaction` by internal system processes, such as the Recon Engine.

**Prisma Schema Definition (`Entry` model from `prisma/schema.prisma`):**
```prisma
enum EntryStatus {
  EXPECTED  // Anticipated movement, possibly generated by a rule or system logic.
  POSTED    // Confirmed, final entry impacting the ledger's posted_balance.
  ARCHIVED  // Superseded, corrected, or otherwise no longer active; discarded_at should be set.
}

model Entry {
  entry_id         String      @id @default(cuid())
  account_id       String
  transaction_id   String      // Foreign Key to Transaction model (Mandatory)
  entry_type       EntryType   // Reuses existing DEBIT/CREDIT enum
  amount           Decimal
  currency         String
  status           EntryStatus
  effective_date   DateTime
  metadata         Json?       @db.JsonB
  discarded_at     DateTime?   // Set when status is ARCHIVED
  created_at       DateTime    @default(now())
  updated_at       DateTime    @updatedAt

  account          Account     @relation(fields: [account_id], references: [account_id])
  transaction      Transaction @relation(fields: [transaction_id], references: [transaction_id]) // Link to Transaction model (Mandatory)
}
```

**Metadata Details (`metadata` - JSON, Optional):**
- A flexible JSONB field to store any additional, non-standardized information related to the entry.
- **Commonly used metadata fields by the Recon Engine:**
  - `order_id`: Propagated from `StagingEntry.metadata`, used for matching.
  - `source_staging_entry_id`: The ID of the `StagingEntry` that originated this entry or the expectation.
  - `recon_rule_id`: (For initial 'expected' entries) The ID of the `ReconRule` used to generate the expected entry.
  - `fulfilled_expected_entry_id`: (For `POSTED` entries created from a `StagingEntry` that matched an `EXPECTED` entry) The ID of the `EXPECTED` entry that was fulfilled.
  - `derived_from_entry_id`: (For `POSTED` entries in an evolved transaction that correspond to the original transaction's posted leg) The ID of the entry in the archived transaction from which this entry was derived.
- Example: `{"order_id": "order-xyz", "source_staging_entry_id": "staging-abc", "fulfilled_expected_entry_id": "expected-entry-123"}`

**API Endpoints:**
- `GET /api/accounts/:account_id/entries`: List entries for the specified account. Supports filtering by `status` (e.g., `EXPECTED`, `POSTED`, `ARCHIVED`) via query parameters.
  - **Response Update:** The API response now includes details of the associated `transaction` for each entry, including `transaction.status`, `transaction.transaction_id`, `transaction.logical_transaction_id`, and `transaction.version`.
  - **Note:** There is no `POST` endpoint for creating entries directly via the API. Entries are created through internal system processes and *must* be associated with a transaction.

**Core Logic (`src/server/core/entry/index.js`):**
- `listEntries(account_id, queryParams)`: Retrieves entries for a given account, allowing filtering by status. Includes related account details and now also includes associated transaction details (status, ID, logical ID, version).
- `createEntryInternal(entryData, tx?)`: (Internal function) Creates a single entry. Accepts an optional Prisma transaction client (`tx`) to participate in an ongoing database transaction. This is used by `transactionCore.createTransactionInternal`.

**Lifecycle & Purpose:**
- `EXPECTED`:
    - Indicates an entry that is anticipated based on a rule or prior event but has not yet been confirmed by an actual corresponding event.
    - The Recon Engine generates 'expected' entries as part of an initial `POSTED` transaction (which has one `POSTED` leg and one `EXPECTED` leg).
    - When a `StagingEntry` matches an `EXPECTED` entry, this `EXPECTED` entry does not directly change status. Instead, the transaction it belongs to is `ARCHIVED`, and a new, fully `POSTED` transaction is created. The `matchedExpectedEntry`'s data is used to create one of the new `POSTED` entries in the evolved transaction.
- `POSTED`:
    - A confirmed financial movement that has impacted an account's balance. This is the primary active state for ledger entries.
    - Can be created initially from a `StagingEntry` (as one leg of a transaction that also has an `EXPECTED` leg).
    - Can also be created as part of an "evolved" transaction when an `EXPECTED` entry is fulfilled by a `StagingEntry`. In this case, both entries in the new transaction version will be `POSTED`.
- `ARCHIVED`:
    - An entry that is no longer active, typically because it is part of an `ARCHIVED` transaction.
    - This occurs when a transaction is superseded by a newer version (due to fulfillment of an expectation or a manual correction).
    - When a transaction is archived, its constituent entries also have their status updated to `ARCHIVED` and their `discarded_at` field is set.

**Relationship with Transactions:**
- An `Entry` *must* always belong to exactly one `Transaction`.
- The Recon Engine is responsible for creating transactions and their associated entries, ensuring that when an expected payment is matched:
    1. The original transaction (containing the `EXPECTED` entry) is archived.
    2. A new, evolved transaction is created with the same `logical_transaction_id` and an incremented `version`.
    3. This new transaction contains two `POSTED` entries: one from the fulfilling `StagingEntry` and one carried over from the original transaction's `POSTED` leg.
