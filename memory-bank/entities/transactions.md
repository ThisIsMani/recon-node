# Entity: Transactions

**Overview:**
Transactions group one or more related `Entry` records that constitute a single, logical financial event or a distinct stage of an event. They support versioning for corrections.

**Prisma Schema Definition (`Transaction` model from `prisma/schema.prisma`):**
```prisma
enum TransactionStatus {
  EXPECTED
  POSTED
  MISMATCH
  ARCHIVED
}

model Transaction {
  transaction_id         String            @id @default(cuid())
  logical_transaction_id String            @default(cuid())
  version                Int               @default(1)
  merchant_id            String            @db.VarChar(255)
  status                 TransactionStatus
  amount                 Decimal           @db.Decimal(19, 4)
  currency               String            @db.VarChar(3)
  created_at             DateTime          @default(now())
  updated_at             DateTime          @updatedAt
  discarded_at           DateTime?
  metadata               Json?             @db.JsonB

  merchant               MerchantAccount   @relation(fields: [merchant_id], references: [merchant_id])
  entries                Entry[]           // Relation to multiple entries

  @@index([logical_transaction_id])
  @@index([merchant_id])
  @@index([status])
  @@unique([logical_transaction_id, version])
}
```

**API Endpoints:**
- `GET /api/merchants/:merchant_id/transactions`: List transactions for the specified merchant. Supports filtering by `status`, `logical_transaction_id`, and `version` via query parameters.
  - **Response Structure:** Returns a grouped list where transactions are organized by `logical_transaction_id`, with all versions included within each group. Each transaction includes arrays of `from_accounts` and `to_accounts` derived from its associated entries.
  - **Note:** There is no `POST` endpoint for creating transactions directly via the API. Transactions are created through internal system processes.

**Core Logic (`src/server/core/transaction/index.ts`):**
- `listTransactions(merchant_id, queryParams)`: Retrieves transactions for a given merchant, allowing filtering. Returns transactions grouped by `logical_transaction_id` with all versions included.
- `createTransactionInternal(transactionShellData, actualEntryData, expectedEntryData, callingTx?)`: (Internal function) Creates a transaction and its two associated, balanced entries (actual and expected) atomically using `prisma.$transaction`. It performs a balancing check (debits vs. credits) before creation.
  - `transactionShellData`: Contains `merchant_id`, `status`, `amount`, `currency`, `metadata`, etc.
  - `actualEntryData`, `expectedEntryData`: Data for the two entries to be created.
  - `callingTx` (optional): Allows participation in an existing Prisma transaction.
  - Throws `BalanceError` if entries do not balance or have mismatched currencies.

**Lifecycle & Purpose:**
- `EXPECTED`: Typically, a transaction initially created by the recon engine will have one `POSTED` entry (from an initial staging entry) and one `EXPECTED` entry (the contra-entry). The transaction status itself will be `POSTED` in this scenario, but it contains an expected leg.
- `POSTED`:
    - An initial transaction generated by the recon engine from a single staging entry will have this status, containing one `POSTED` entry and one `EXPECTED` entry.
    - A transaction that results from the fulfillment of an `EXPECTED` entry (Phase 2 evolution) will have this status and contain two (or more) `POSTED` entries, representing a fully reconciled event.
- `MISMATCH`: Discrepancies found during the matching process between a `StagingEntry` and an `EXPECTED` entry in an existing transaction. The original transaction is marked `MISMATCH`.
- `ARCHIVED`: This version of the transaction has been superseded by a newer version, either due to the fulfillment of its `EXPECTED` entry (leading to an evolved `POSTED` transaction) or due to a manual correction. `discarded_at` should be set.

**Versioning for Evolution (Fulfillment & Corrections):**
Transactions evolve using the `logical_transaction_id` and `version` fields.
-   **Fulfillment of Expected Entries (Transaction Evolution):**
    -   When a `StagingEntry` successfully matches and validates against an `EXPECTED` entry within an existing `Transaction` (which typically has one `POSTED` and one `EXPECTED` leg and `status: POSTED`), the following occurs:
        1.  The `originalTransaction` (the one containing the `matchedExpectedEntry`) is updated to `status: ARCHIVED` and its `discarded_at` timestamp is set.
        2.  A `newEvolvedTransaction` is created with:
            -   The same `logical_transaction_id` as the `originalTransaction`.
            -   `version: originalTransaction.version + 1`.
            -   `status: TransactionStatus.POSTED`.
            -   This `newEvolvedTransaction` will contain two `POSTED` entries:
                -   One entry derived from the fulfilling `StagingEntry`.
                -   One entry derived from the original `POSTED` leg of the `originalTransaction`.
            -   Metadata on the new transaction and its entries will link back to the `stagingEntry`, `matchedExpectedEntry`, and `originalTransaction`.
-   **Corrections:** If a fully `POSTED` transaction (all entries are `POSTED`) needs correction (a process not yet fully defined but anticipated), its status would become `ARCHIVED`. A new transaction would be created with the same `logical_transaction_id`, an incremented `version`, and the corrected set of entries.

**Relationship with Entries:**
- A `Transaction` groups one or more `Entry` records.
- The relationship is one-to-many: one `Transaction` can have multiple `Entry` records, and each `Entry` *must* belong to exactly one `Transaction` (enforced by the mandatory `Entry.transaction_id` foreign key).
- Internal processes, like `createTransactionInternal` or the Recon Engine, are responsible for creating `Transaction` records and ensuring all associated `Entry` records are correctly linked.
