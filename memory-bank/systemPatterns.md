# System Patterns: Smart Ledger Backend (Node.js)

**Architecture:**
- **Web Server:** Node.js with Express.js framework.
- **API Endpoints:** RESTful API endpoints for interacting with the ledger (e.g., `/api/health`, and entity-specific endpoints like `/api/merchants`, `/api/accounts`).
- **Database:** PostgreSQL.
- **ORM/Migration Tool:** Prisma for schema management, migrations, and database access (via Prisma Client).
- **Modularity:** The application is structured into:
    - `prisma`: Contains `schema.prisma` (schema definition) and is used by Prisma CLI.
    - `migrations`: Contains SQL migration files generated by Prisma.
    - `config`: Application configuration.
    - `services`: Shared services, primarily `prisma.js` (exporting Prisma Client instance).
    - `db_models`: (Potentially less used if Prisma schema is the primary source of truth, but could hold complex raw queries or view definitions).
    - `api_models`: Intended for request/response data structure definitions or validation schemas.
    - `server/routes`: Defines API routes and maps them to handlers. Organized by entity (e.g., `server/routes/merchant/`, `server/routes/account/`).
    - `server/core`: Contains the core business logic (services) for each feature. Organized by entity (e.g., `server/core/merchant/`, `server/core/account/`).
    - `utils`: Common utility functions.

**General Data Flow (Example for a typical entity):**
1.  HTTP request hits an API endpoint (e.g., `POST /api/<entity-name>`).
2.  The route handler in `src/server/routes/<entity-name>/index.js` receives the request.
3.  The handler calls a service function in `src/server/core/<entity-name>/index.js`, passing validated request data.
4.  The core service function implements the business logic:
    - Interacts with Prisma Client (from `src/services/prisma.js`) to perform database operations (e.g., `prisma.<entityModel>.create()`).
    - May involve related entities or specific business rules.
5.  The core service function returns a result to the route handler.
6.  The route handler sends an HTTP JSON response.
    *Specific data flow examples for entities like "Sales" or "Transactions" will be detailed in their respective `memory-bank/entities/` documents as they are developed.*

**Key Design Patterns:**
- **Service Layer:** Business logic is encapsulated in `core` modules, separating it from route handling.
- **Repository/Data Access Layer:** Prisma Client (exported from `services/prisma.js`) provides data access methods.
- **Configuration Management:** Environment variables (`.env` file, loaded by `dotenv`) are used for sensitive or environment-specific settings, managed via `src/config/index.js`. `DATABASE_URL` in `.env` is crucial for Prisma.
- **Connection Pooling:** Handled internally by Prisma Client.
- **Asynchronous Operations:** Extensive use of `async/await` for non-blocking I/O (database calls, etc.).
- **Centralized Routing:** A main router (`src/server/routes/index.js`) aggregates feature-specific routers.
- **Error Handling:** Basic centralized error handling middleware in `src/app.js`. Prisma-specific errors (e.g., unique constraint violations) are handled in core logic.
- **API Documentation:** Swagger UI served at `/api-docs`, generated from JSDoc comments in route files using `swagger-jsdoc` and `swagger-ui-express`.
- **Producer-Consumer Pattern (Recon Engine):**
    - **Process Tracker (`src/server/core/process-tracker`):** A database-backed queue (`ProcessTracker` model) manages tasks for asynchronous processing. Core functions include `createTask`, `getNextPendingTask`, `updateTaskStatus`.
    - **Producer (`src/server/core/staging-entry`):** The `createStagingEntry` function acts as a producer. Upon successful creation of a `StagingEntry`, it enqueues a `PROCESS_STAGING_ENTRY` task into the Process Tracker.
    - **Consumer (`src/server/core/recon-engine/consumer.js`):** A separate process (run by `src/recon-engine-runner.js`) that polls the Process Tracker for pending tasks.
        - It fetches `StagingEntry` data based on task payload.
        - Transforms `StagingEntry` data into `Transaction` and linked `Entry` records using internal core functions (`transactionCore.createTransactionInternal`, which calls `entryCore.createEntryInternal`).
        - Updates `StagingEntry` and `ProcessTracker` task statuses.
    - This pattern decouples the initial data ingestion (e.g., API creating `StagingEntry`) from more complex, potentially long-running processing, improving API responsiveness and system resilience.
