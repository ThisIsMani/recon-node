# System Patterns: Smart Ledger Backend (Node.js)

**Architecture:**
- **Web Server:** Node.js with Express.js framework.
- **API Endpoints:** RESTful API endpoints for interacting with the ledger (e.g., `/api/health`, future: `/api/sales`, `/api/settlements`).
- **Database:** PostgreSQL.
- **ORM/Migration Tool:** Prisma for schema management, migrations, and database access (via Prisma Client).
- **Modularity:** The application is structured into:
    - `prisma`: Contains `schema.prisma` (schema definition) and is used by Prisma CLI.
    - `migrations`: Contains SQL migration files generated by Prisma.
    - `config`: Application configuration.
    - `services`: Shared services, primarily `prisma.js` (exporting Prisma Client instance).
    - `db_models`: (Potentially less used if Prisma schema is the primary source of truth, but could hold complex raw queries or view definitions).
    - `api_models`: Intended for request/response data structure definitions or validation schemas.
    - `server/routes`: Defines API routes and maps them to handlers.
    - `server/core`: Contains the core business logic (services) for each feature.
    - `utils`: Common utility functions.

**Data Flow (Example: Recording a Sale):**
1.  HTTP request hits an API endpoint (e.g., `POST /api/sales`).
2.  The route handler in `src/server/routes/sales.js` (to be created) receives the request.
3.  The handler calls a service function in `src/server/core/sales.js` (to be created), passing validated request data.
4.  The core service function implements the Smart Ledger logic:
    - Interacts with Prisma Client (from `src/services/prisma.js`) to perform database operations (e.g., `prisma.entry.create()`).
    - Creates "expected" entries based on defined rules.
5.  The core service function returns a result to the route handler.
6.  The route handler sends an HTTP JSON response.

**Key Design Patterns:**
- **Service Layer:** Business logic is encapsulated in `core` modules, separating it from route handling.
- **Repository/Data Access Layer:** Prisma Client (exported from `services/prisma.js`) provides data access methods.
- **Configuration Management:** Environment variables (`.env` file, loaded by `dotenv`) are used for sensitive or environment-specific settings, managed via `src/config/index.js`. `DATABASE_URL` in `.env` is crucial for Prisma.
- **Connection Pooling:** Handled internally by Prisma Client.
- **Asynchronous Operations:** Extensive use of `async/await` for non-blocking I/O (database calls, etc.).
- **Centralized Routing:** A main router (`src/server/routes/index.js`) aggregates feature-specific routers.
- **Error Handling:** Basic centralized error handling middleware in `src/app.js`. Prisma-specific errors (e.g., unique constraint violations) are handled in core logic.
- **API Documentation:** Swagger UI served at `/api-docs`, generated from JSDoc comments in route files using `swagger-jsdoc` and `swagger-ui-express`.
